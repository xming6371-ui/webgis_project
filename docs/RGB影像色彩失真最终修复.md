# RGBå½±åƒè‰²å½©å¤±çœŸæœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

## ğŸ”´ é—®é¢˜ç°è±¡

ä¼˜åŒ–åçš„RGBå½±åƒå‡ºç°**ä¸¥é‡è‰²å½©å¤±çœŸ**ï¼š
- âœ— ä¸»ä½“åŒºåŸŸï¼š**ç²‰çº¢è‰²**ï¼ˆåº”è¯¥æ˜¯ç»¿è‰²æ¤è¢«/æ£•è‰²åœŸå£¤ï¼‰
- âœ— èƒŒæ™¯åŒºåŸŸï¼š**é’ç»¿è‰²**ï¼ˆåº”è¯¥æ˜¯é€æ˜æˆ–é»‘è‰²ï¼‰
- âœ— å®Œå…¨ä¸æ˜¯çœŸå®çš„RGBé¢œè‰²

## ğŸ” æ ¹æœ¬åŸå› 

### åŸå§‹æ•°æ®ç‰¹å¾
```
Band 1 (çº¢): 1.00 ~ 19297.00
Band 2 (ç»¿): 1.00 ~ 18624.00
Band 3 (è“): 151.00 ~ 17312.00  â† æ³¨æ„ï¼šæœ€å°å€¼æ˜¯151ï¼Œä¸æ˜¯1ï¼
```

### ä¹‹å‰çš„é”™è¯¯ç­–ç•¥ï¼ˆç»Ÿä¸€æ‹‰ä¼¸ï¼‰

```javascript
// âŒ ä½¿ç”¨å…¨å±€min/maxç»Ÿä¸€æ‹‰ä¼¸
effectiveMin = Math.min(1, 1, 151) = 1
æ‹‰ä¼¸èŒƒå›´: 1 ~ 5790 (30%)

// é—®é¢˜ï¼š
gdal_translate -scale 1 5790 0 255
```

**ä¸ºä»€ä¹ˆä¼šå¤±çœŸï¼Ÿ**

| æ³¢æ®µ | å®é™…èŒƒå›´ | ç»Ÿä¸€æ‹‰ä¼¸ | é—®é¢˜ |
|-----|---------|---------|------|
| Band 1 (çº¢) | 1-19297 | 1-5790 | âœ“ æ­£å¸¸ |
| Band 2 (ç»¿) | 1-18624 | 1-5790 | âœ“ æ­£å¸¸ |
| Band 3 (è“) | **151**-17312 | 1-5790 | âŒ 0-150è¢«é”™è¯¯æ˜ å°„ï¼|

**ç»“æœï¼š**
- Band 3çš„**0-150åŒºåŸŸ**ï¼ˆèƒŒæ™¯ï¼‰è¢«æ˜ å°„åˆ°æŸä¸ªé”™è¯¯çš„å€¼
- å¯¼è‡´**é’ç»¿è‰²èƒŒæ™¯**ï¼ˆBand 1+Band 2äº®ï¼ŒBand 3æš—ï¼‰
- ä¸»ä½“åŒºåŸŸçš„è‰²å½©æ¯”ä¾‹ä¹Ÿé”™è¯¯ï¼ˆ**ç²‰çº¢è‰²**ï¼‰

### è§†è§‰æ•ˆæœåˆ†æ

**é’ç»¿è‰²èƒŒæ™¯ = çº¢è‰² + ç»¿è‰² - è“è‰²**
```
RGB(200, 200, 50) â†’ é’ç»¿è‰²
```

è¿™æ­£å¥½è¯æ˜äº†Band 3è¢«é”™è¯¯æ‹‰ä¼¸åˆ°äº†ä½å€¼ã€‚

## âœ… æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯ï¼šç‹¬ç«‹æ³¢æ®µæ‹‰ä¼¸ + ç›¸åŒç™¾åˆ†æ¯”

**ä¸ä½¿ç”¨ç»Ÿä¸€çš„æ‹‰ä¼¸èŒƒå›´ï¼Œè€Œæ˜¯å¯¹æ¯ä¸ªæ³¢æ®µåˆ†åˆ«æ‹‰ä¼¸ï¼Œä½†ä½¿ç”¨ç›¸åŒçš„ç™¾åˆ†æ¯”ï¼ˆ30%ï¼‰ï¼š**

```javascript
// âœ… æ¯ä¸ªæ³¢æ®µç‹¬ç«‹æ‹‰ä¼¸
const stretchPercent = 0.3  // 30%

Band 1: 1 ~ (1 + (19297-1) * 0.3) = 1 ~ 5789
Band 2: 1 ~ (1 + (18624-1) * 0.3) = 1 ~ 5587
Band 3: 151 ~ (151 + (17312-151) * 0.3) = 151 ~ 5299

// GDALå‘½ä»¤ï¼š
gdal_translate -ot Byte \
  -scale_1 1 5789 0 255 \      # Band 1ç‹¬ç«‹æ‹‰ä¼¸
  -scale_2 1 5587 0 255 \      # Band 2ç‹¬ç«‹æ‹‰ä¼¸
  -scale_3 151 5299 0 255 \    # Band 3ç‹¬ç«‹æ‹‰ä¼¸
  -a_nodata 0 \
  -of GTiff
```

### ä¸ºä»€ä¹ˆè¿™æ ·å¯ä»¥è§£å†³é—®é¢˜ï¼Ÿ

| æ³¢æ®µ | å®é™…èŒƒå›´ | ç‹¬ç«‹æ‹‰ä¼¸ | æ•ˆæœ |
|-----|---------|---------|------|
| Band 1 (çº¢) | 1-19297 | 1-5789 (30%) | âœ“ æ­£å¸¸ |
| Band 2 (ç»¿) | 1-18624 | 1-5587 (30%) | âœ“ æ­£å¸¸ |
| Band 3 (è“) | 151-17312 | **151**-5299 (30%) | âœ“ å°Šé‡å®é™…èŒƒå›´ï¼|

**å…³é”®ç‚¹ï¼š**
1. âœ… æ¯ä¸ªæ³¢æ®µä»**è‡ªå·±çš„æœ€å°å€¼**å¼€å§‹æ‹‰ä¼¸
2. âœ… ä½¿ç”¨ç›¸åŒçš„ç™¾åˆ†æ¯”ï¼ˆ30%ï¼‰ï¼Œä¿æŒ**ç›¸å¯¹è‰²å½©å¹³è¡¡**
3. âœ… é¿å…ä½å€¼åŒºåŸŸè¢«é”™è¯¯æ˜ å°„
4. âœ… ä¿ç•™NoDataï¼ˆ0å€¼ï¼‰ä¸ºé€æ˜

### ä¸ºä»€ä¹ˆä¸ä¼šå½±å“è‰²å½©å¹³è¡¡ï¼Ÿ

**è‰²å½©å¹³è¡¡çš„å…³é”®æ˜¯"ç›¸å¯¹æ¯”ä¾‹"ï¼Œè€Œä¸æ˜¯"ç»å¯¹èŒƒå›´"ï¼š**

å‡è®¾æŸä¸ªåƒç´ çš„åŸå§‹å€¼ï¼š
```
Band 1: 3000 (15.5% of 19297)
Band 2: 2800 (15.0% of 18624)
Band 3: 2600 (14.3% of 17312)
```

**ç»Ÿä¸€æ‹‰ä¼¸ï¼ˆé”™è¯¯ï¼‰ï¼š**
```
Band 1: 3000 â†’ (3000-1)/(5790-1) * 255 = 132
Band 2: 2800 â†’ (2800-1)/(5790-1) * 255 = 123
Band 3: 2600 â†’ (2600-1)/(5790-1) * 255 = 114  â† ä½†Band 3çš„æœ‰æ•ˆèŒƒå›´ä»151å¼€å§‹ï¼
å®é™…ï¼šBand 3: 2600 â†’ (2600-1)/(5790-1) * 255 = 114 (é”™è¯¯ï¼)
```

**ç‹¬ç«‹æ‹‰ä¼¸ï¼ˆæ­£ç¡®ï¼‰ï¼š**
```
Band 1: 3000 â†’ (3000-1)/(5789-1) * 255 = 132
Band 2: 2800 â†’ (2800-1)/(5587-1) * 255 = 128
Band 3: 2600 â†’ (2600-151)/(5299-151) * 255 = 121  â† æ­£ç¡®ï¼
```

**ç»“æœï¼šRGB(132, 128, 121) â†’ ç°ç™½è‰²ï¼ˆæ­£å¸¸ï¼‰**

## ğŸ“Š ä»£ç å®ç°

### ä¿®å¤å‰ï¼ˆç»Ÿä¸€æ‹‰ä¼¸ï¼‰

```javascript
// âŒ ç»Ÿä¸€æ‹‰ä¼¸
let effectiveMin = Math.min(band1.min, band2.min, band3.min)  // = 1
const effectiveMax = Math.max(band1.max, band2.max, band3.max)  // = 19297
const conservativeMax = effectiveMin + (effectiveMax - effectiveMin) * 0.3

translateCmd = `gdal_translate -ot Byte -scale ${effectiveMin} ${conservativeMax} 0 255 -a_nodata 0`
```

### ä¿®å¤åï¼ˆç‹¬ç«‹æ‹‰ä¼¸ï¼‰

```javascript
// âœ… ç‹¬ç«‹æ³¢æ®µæ‹‰ä¼¸
const stretchPercent = 0.3

// å¤„ç†NoData
const getEffectiveMin = (bandMin) => {
  return (hasNoData && bandMin === 0) ? 1 : bandMin
}

const b1Min = getEffectiveMin(band1.min)  // 1
const b2Min = getEffectiveMin(band2.min)  // 1
const b3Min = getEffectiveMin(band3.min)  // 151

// è®¡ç®—æ¯ä¸ªæ³¢æ®µçš„æ‹‰ä¼¸èŒƒå›´
const b1Max = b1Min + (band1.max - b1Min) * stretchPercent  // 5789
const b2Max = b2Min + (band2.max - b2Min) * stretchPercent  // 5587
const b3Max = b3Min + (band3.max - b3Min) * stretchPercent  // 5299

// GDALå‘½ä»¤ï¼šä½¿ç”¨-scale_1, -scale_2, -scale_3åˆ†åˆ«æŒ‡å®š
translateCmd = `gdal_translate -ot Byte \
  -scale_1 ${b1Min} ${b1Max} 0 255 \
  -scale_2 ${b2Min} ${b2Max} 0 255 \
  -scale_3 ${b3Min} ${b3Max} 0 255 \
  -a_nodata 0 -of GTiff`
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. åˆ é™¤æ—§çš„ä¼˜åŒ–æ–‡ä»¶
```powershell
cd public/data/data_tif
rm KEC20250810RGB_optimized.tif
```

### 2. é‡å¯åç«¯æœåŠ¡
```powershell
# Ctrl+C åœæ­¢
cd server
node app.js
```

### 3. é‡æ–°ä¼˜åŒ–å¹¶æ£€æŸ¥æ—¥å¿—

**åº”è¯¥çœ‹åˆ°ï¼š**
```
ğŸ“Š å¤§èŒƒå›´æ•°æ®ï¼Œä½¿ç”¨ç‹¬ç«‹æ³¢æ®µæ‹‰ä¼¸ï¼ˆä¿æŒç›¸å¯¹å¹³è¡¡ï¼‰
Band 1 æ‹‰ä¼¸: 1.00 ~ 5789.00 (å‰30%)
Band 2 æ‹‰ä¼¸: 1.00 ~ 5587.00 (å‰30%)
Band 3 æ‹‰ä¼¸: 151.00 ~ 5299.00 (å‰30%)  â† å…³é”®ï¼šä»151å¼€å§‹
âš ï¸ ç‹¬ç«‹æ‹‰ä¼¸é¿å…è‰²å½©å¤±çœŸï¼Œä¿æŒåŸå§‹äº®åº¦

æ­¥éª¤1/2: æ•°æ®ç±»å‹è½¬æ¢ï¼ˆFloat32 â†’ Byteï¼‰
âœ… ç‹¬ç«‹æ³¢æ®µæ‹‰ä¼¸ï¼ˆä½¿ç”¨ç›¸åŒç™¾åˆ†æ¯”ï¼Œä¿æŒè‰²å½©å¹³è¡¡ï¼‰
âœ… ä¿ç•™NoDataå€¼ï¼ˆèƒŒæ™¯é€æ˜ï¼‰

å‘½ä»¤: gdal_translate.exe -ot Byte 
  -scale_1 1 5789 0 255 
  -scale_2 1 5587 0 255 
  -scale_3 151 5299 0 255 
  -a_nodata 0 ...
```

### 4. éªŒè¯ç¼©ç•¥å›¾æ•ˆæœ

**åº”è¯¥çœ‹åˆ°ï¼š**
- âœ… **çœŸå®çš„RGBé¢œè‰²**ï¼ˆç»¿è‰²æ¤è¢«ã€æ£•è‰²åœŸå£¤ã€è“è‰²æ°´ä½“ï¼‰
- âœ… **é€æ˜èƒŒæ™¯**ï¼ˆä¸æ˜¯é’ç»¿è‰²æˆ–å…¶ä»–é¢œè‰²ï¼‰
- âœ… **äº®åº¦é€‚ä¸­**ï¼ˆä¸ä¼šå¤ªæš—ï¼‰
- âœ… **ç»†èŠ‚æ¸…æ™°**

## ğŸ¯ æŠ€æœ¯ç»†èŠ‚

### GDALçš„-scale_Nå‚æ•°

```bash
# -scale_N: å¯¹ç¬¬Nä¸ªæ³¢æ®µå•ç‹¬æ‹‰ä¼¸
-scale_1 <src_min> <src_max> <dst_min> <dst_max>  # Band 1
-scale_2 <src_min> <src_max> <dst_min> <dst_max>  # Band 2
-scale_3 <src_min> <src_max> <dst_min> <dst_max>  # Band 3
```

### ä¸ºä»€ä¹ˆä¹‹å‰æ²¡æœ‰ä½¿ç”¨ç‹¬ç«‹æ‹‰ä¼¸ï¼Ÿ

ä¹‹å‰æ‹…å¿ƒ**ç‹¬ç«‹æ‹‰ä¼¸ä¼šå¯¼è‡´è‰²å½©å¤±çœŸ**ï¼Œå› ä¸ºï¼š
- å¦‚æœBand 1æ‹‰ä¼¸10å€ï¼ŒBand 2æ‹‰ä¼¸2å€ï¼ŒBand 3æ‹‰ä¼¸5å€
- ä¼šå¯¼è‡´è‰²å½©æ¯”ä¾‹å®Œå…¨é”™è¯¯

**ä½†ç°åœ¨çš„æ–¹æ¡ˆæ˜¯ï¼š**
- æ‰€æœ‰æ³¢æ®µä½¿ç”¨**ç›¸åŒçš„ç™¾åˆ†æ¯”**ï¼ˆ30%ï¼‰
- åªæ˜¯**èµ·ç‚¹ä¸åŒ**ï¼ˆå°Šé‡æ¯ä¸ªæ³¢æ®µçš„å®é™…æœ€å°å€¼ï¼‰
- è¿™æ ·æ—¢ä¿æŒäº†ç›¸å¯¹å¹³è¡¡ï¼Œåˆé¿å…äº†èŒƒå›´é”™è¯¯

### ä¸ä¹‹å‰æ–¹æ¡ˆçš„å¯¹æ¯”

| æ–¹æ¡ˆ | æ‹‰ä¼¸æ–¹å¼ | Band 3å¤„ç† | è‰²å½©æ•ˆæœ | èƒŒæ™¯ |
|-----|---------|-----------|---------|------|
| **æ–¹æ¡ˆ1** (ç‹¬ç«‹ç™¾åˆ†ä½) | ç‹¬ç«‹æ‹‰ä¼¸ | 2%-98% | âŒ å¤±çœŸ | âœ“ é€æ˜ |
| **æ–¹æ¡ˆ2** (ç»Ÿä¸€èŒƒå›´) | ç»Ÿä¸€æ‹‰ä¼¸ | 1-19297 | âŒ å¤ªæš— | âœ“ é€æ˜ |
| **æ–¹æ¡ˆ3** (ç»Ÿä¸€30%) | ç»Ÿä¸€æ‹‰ä¼¸ | 1-5790 | âŒ å¤±çœŸ | âŒ é’ç»¿è‰² |
| **æ–¹æ¡ˆ4** (ç‹¬ç«‹30%) | **ç‹¬ç«‹æ‹‰ä¼¸ï¼ˆç›¸åŒ%ï¼‰** | **151-5299** | âœ… æ­£å¸¸ | âœ… é€æ˜ |

## ğŸ“Š é¢„æœŸæ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆç»Ÿä¸€æ‹‰ä¼¸ï¼‰

```
å½±åƒ: ç²‰çº¢è‰²ä¸»ä½“ + é’ç»¿è‰²èƒŒæ™¯
åŸå› : Band 3çš„ä½å€¼åŒºåŸŸè¢«é”™è¯¯æ˜ å°„
```

### ä¿®å¤åï¼ˆç‹¬ç«‹æ‹‰ä¼¸ï¼‰

```
å½±åƒ: çœŸå®RGBé¢œè‰² + é€æ˜èƒŒæ™¯
åŸå› : æ¯ä¸ªæ³¢æ®µä»æ­£ç¡®çš„èµ·ç‚¹æ‹‰ä¼¸
```

## ğŸ’¡ ç»éªŒæ€»ç»“

### æ•™è®­ï¼šç»Ÿä¸€æ‹‰ä¼¸çš„é™·é˜±

**ä¸è¦ç®€å•åœ°ä½¿ç”¨å…¨å±€min/maxï¼**

å¯¹äºå¤šæ³¢æ®µå½±åƒï¼Œå°¤å…¶æ˜¯RGBï¼š
1. âœ… æ£€æŸ¥æ¯ä¸ªæ³¢æ®µçš„**å®é™…å€¼åŸŸ**
2. âœ… å¦‚æœå„æ³¢æ®µçš„min/maxå·®å¼‚å¾ˆå¤§ï¼Œä½¿ç”¨**ç‹¬ç«‹æ‹‰ä¼¸**
3. âœ… ä½¿ç”¨**ç›¸åŒç™¾åˆ†æ¯”**ä¿æŒè‰²å½©å¹³è¡¡
4. âœ… å°Šé‡æ¯ä¸ªæ³¢æ®µçš„**æœ‰æ•ˆèµ·ç‚¹**

### æœ€ä½³å®è·µ

```javascript
// 1. è·å–æ¯ä¸ªæ³¢æ®µçš„ç»Ÿè®¡ä¿¡æ¯
const band1 = getBandStats(1)
const band2 = getBandStats(2)
const band3 = getBandStats(3)

// 2. æ£€æŸ¥æ˜¯å¦æœ‰NoData
const hasNoData = band1.min === 0 || band2.min === 0 || band3.min === 0

// 3. å¤„ç†æœ‰æ•ˆæœ€å°å€¼
const b1Min = hasNoData && band1.min === 0 ? 1 : band1.min
const b2Min = hasNoData && band2.min === 0 ? 1 : band2.min
const b3Min = hasNoData && band3.min === 0 ? 1 : band3.min

// 4. ä½¿ç”¨ç›¸åŒç™¾åˆ†æ¯”è®¡ç®—æ‹‰ä¼¸èŒƒå›´
const percent = 0.3
const b1Max = b1Min + (band1.max - b1Min) * percent
const b2Max = b2Min + (band2.max - b2Min) * percent
const b3Max = b3Min + (band3.max - b3Min) * percent

// 5. ç‹¬ç«‹æ‹‰ä¼¸
gdal_translate -ot Byte \
  -scale_1 ${b1Min} ${b1Max} 0 255 \
  -scale_2 ${b2Min} ${b2Max} 0 255 \
  -scale_3 ${b3Min} ${b3Max} 0 255 \
  -a_nodata 0
```

## ğŸ”§ å¯èƒ½éœ€è¦çš„è°ƒæ•´

### å¦‚æœè‰²å½©ä»ç„¶åè‰²

æ£€æŸ¥æ—¥å¿—ä¸­çš„æ‹‰ä¼¸èŒƒå›´ï¼Œç¡®ä¿ï¼š
- âœ… æ¯ä¸ªæ³¢æ®µçš„èµ·ç‚¹æ­£ç¡®ï¼ˆBand 3åº”è¯¥ä»151å¼€å§‹ï¼Œä¸æ˜¯1ï¼‰
- âœ… ä½¿ç”¨äº† `-scale_1`, `-scale_2`, `-scale_3` ç‹¬ç«‹æ‹‰ä¼¸
- âœ… ç™¾åˆ†æ¯”ä¸€è‡´ï¼ˆéƒ½æ˜¯30%ï¼‰

### å¦‚æœå½±åƒå¤ªæš—æˆ–å¤ªäº®

è°ƒæ•´ `stretchPercent`ï¼š
- å¤ªæš—ï¼šå‡å°åˆ° `0.2` (20%)
- å¤ªäº®ï¼šå¢å¤§åˆ° `0.4` (40%)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v5.0 (æœ€ç»ˆç‰ˆ)  
**ä¿®å¤æ—¶é—´**: 2025-10-29  
**é—®é¢˜**: ç»Ÿä¸€æ‹‰ä¼¸å¯¼è‡´Band 3èŒƒå›´é”™è¯¯  
**è§£å†³æ–¹æ¡ˆ**: ç‹¬ç«‹æ³¢æ®µæ‹‰ä¼¸ï¼ˆä½¿ç”¨ç›¸åŒç™¾åˆ†æ¯”ï¼‰

