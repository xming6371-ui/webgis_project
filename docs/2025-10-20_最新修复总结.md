# 2025-10-20 æœ€æ–°ä¿®å¤æ€»ç»“

## âœ… å·²å®Œæˆçš„4é¡¹ä¿®å¤

### 1. ä½œç‰©è½¬æ¢æµå‘å›¾ - æ•°æ®è¯´æ˜ä¼˜åŒ–

**é—®é¢˜**ï¼šç”¨æˆ·ä¸ç†è§£"è½¬æ¢ç±»å‹æ•°"å’Œ"æ€»å˜åŒ–æ¬¡æ•°"çš„å«ä¹‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ äº†ä¿¡æ¯æç¤ºæ¡†ï¼Œæ¸…æ™°è¯´æ˜ä¸¤ä¸ªæ•°å­—çš„å«ä¹‰
- æ–‡ä»¶ï¼š`src/views/ResultCompare/components/CropTransitionChart.vue`

**æ•°æ®å«ä¹‰è§£é‡Š**ï¼š

1. **è½¬æ¢ç±»å‹æ•°ï¼ˆ44ç§ï¼‰**ï¼š
   - è¡¨ç¤ºæœ‰44ç§ä¸åŒçš„ä½œç‰©è½¬æ¢ç»„åˆ
   - æ¯ä¸€ç§ç‹¬ç‰¹çš„"èµ·å§‹ä½œç‰© â†’ ç»“æŸä½œç‰©"ç»„åˆç®—ä¸€ç§è½¬æ¢ç±»å‹
   - ä¾‹å¦‚ï¼š"è¾£æ¤’ â†’ å…¶å®ƒè€•åœ°"æ˜¯ä¸€ç§ï¼Œ"è€•åœ° â†’ è¾£æ¤’"æ˜¯å¦ä¸€ç§
   - è¿™44ç§è½¬æ¢ç±»å‹æ˜¯æ ¹æ®æ‚¨çš„å®é™…æ•°æ®ç»Ÿè®¡å‡ºæ¥çš„

2. **å…±188æ¬¡å˜åŒ–**ï¼š
   - è¡¨ç¤ºæ‰€æœ‰ä½œç‰©è½¬æ¢å‘ç”Ÿçš„æ€»æ¬¡æ•°
   - ä¾‹å¦‚ï¼š"è¾£æ¤’ â†’ å…¶å®ƒè€•åœ°"å‘ç”Ÿäº†12æ¬¡ï¼Œ"å°éº¦ â†’ ç±½ç”¨è‘«èŠ¦"å‘ç”Ÿäº†11æ¬¡
   - æ‰€æœ‰è½¬æ¢æ¬¡æ•°ç›¸åŠ  = 188æ¬¡
   - **å·²æ­£ç¡®æ’é™¤æ— å˜åŒ–æƒ…å†µ**ï¼ˆå¦‚"ç‰ç±³ â†’ ç‰ç±³"è¿™ç§ä¸ç®—ï¼‰

**æ–°å¢çš„æç¤ºä¿¡æ¯**ï¼š
```
å…±ç»Ÿè®¡åˆ° 44 ç§ä¸åŒçš„ä½œç‰©è½¬æ¢ç±»å‹ï¼Œæ€»è®¡å‘ç”Ÿ 188 æ¬¡è½¬æ¢ï¼ˆå·²æ’é™¤æ— å˜åŒ–æƒ…å†µï¼‰
```

**æ•°æ®è®¡ç®—é€»è¾‘**ï¼š
```javascript
// åœ¨ src/utils/temporalAnalysis.js ä¸­
function calculateTransitionMatrix(trajectories, timePointsCount) {
  // åªç»Ÿè®¡æœ‰å˜åŒ–çš„åœ°å—
  const changedTrajectories = trajectories.filter(traj => traj.changeCount > 0)
  
  changedTrajectories.forEach(traj => {
    for (let i = 1; i < traj.cropHistory.length; i++) {
      const fromCrop = traj.cropHistory[i - 1]
      const toCrop = traj.cropHistory[i]
      
      // æ’é™¤ç±»å‹ä¸å˜çš„æƒ…å†µ
      if (fromCrop === toCrop) {
        continue
      }
      
      const key = `${fromCrop} â†’ ${toCrop}`
      matrix[key] = (matrix[key] || 0) + 1
      totalChanges++
    }
  })
  
  return { matrix, totalChanges }
}
```

---

### 2. ä½œç‰©åˆ†å¸ƒè¶‹åŠ¿ - å•ä½æ˜¾ç¤ºä¼˜åŒ–

**é—®é¢˜**ï¼šæ˜¾ç¤º"1613ä¸ª"è€Œä¸æ˜¯"1613ä¸ªåœ°å—"

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹äº†æ•°é‡æ˜¾ç¤ºæ ¼å¼ï¼Œæ·»åŠ "åœ°å—"å•ä½
- æ–‡ä»¶ï¼š`src/views/ResultCompare/components/CropDistributionChart.vue`

**ä¿®æ”¹å†…å®¹**ï¼š
```javascript
// getCropValueå‡½æ•°
case 'count':
  return `${crop.count} ä¸ªåœ°å—`  // åŸæ¥æ˜¯ï¼š`${crop.count} ä¸ª`

// getCellValueå‡½æ•°
case 'count':
  return `${cropData.count} ä¸ªåœ°å—`  // åŸæ¥æ˜¯ï¼šcropData.count
```

**æ•ˆæœ**ï¼š
- å·¦ä¾§ä½œç‰©åˆ†å¸ƒï¼šæ˜¾ç¤ºä¸º"1613 ä¸ªåœ°å—"
- è¡¨æ ¼å„æ—¶æœŸå¯¹æ¯”ï¼šæ˜¾ç¤ºä¸º"1613 ä¸ªåœ°å—"
- å½“é€‰æ‹©"é¢ç§¯"æ¨¡å¼æ—¶ï¼šæ˜¾ç¤ºä¸º"XXX äº©"
- å½“é€‰æ‹©"å æ¯”"æ¨¡å¼æ—¶ï¼šæ˜¾ç¤ºä¸º"XX.X%"

---

### 3. npmåŒ…å®‰è£…é—®é¢˜

**é—®é¢˜**ï¼šjspdfã€html2canvasç­‰åŒ…å®‰è£…å¤±è´¥ï¼ˆæƒé™é”™è¯¯ï¼‰

**é”™è¯¯ä¿¡æ¯**ï¼š
```
npm error errno EPERM
npm error FetchError: Invalid response body while trying to fetch https://registry.npmmirror.com/html2canvas: 
EPERM: operation not permitted, open 'D:\APP\nodejs\node_cache\_cacache\tmp\...'
```

**åŸå› åˆ†æ**ï¼š
1. npmç¼“å­˜ç›®å½•æ²¡æœ‰å†™å…¥æƒé™
2. å¯èƒ½è¢«æ€æ¯’è½¯ä»¶é˜»æ­¢
3. æ–‡ä»¶è¢«å…¶ä»–ç¨‹åºå ç”¨

**å®Œæ•´è§£å†³æ–¹æ¡ˆ**ï¼š

#### æ–¹æ³•1ï¼šä»¥ç®¡ç†å‘˜æƒé™å®‰è£…ï¼ˆæ¨èï¼‰

1. **å®Œå…¨å…³é—­æ‰€æœ‰ç›¸å…³è¿›ç¨‹**
   ```
   - å…³é—­VS Code
   - å…³é—­æ‰€æœ‰ç»ˆç«¯/CMDçª—å£
   - æ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨ï¼Œç»“æŸæ‰€æœ‰node.exeè¿›ç¨‹
   - ç»“æŸCode.exeè¿›ç¨‹ï¼ˆå¦‚æœæœ‰ï¼‰
   ```

2. **ä»¥ç®¡ç†å‘˜èº«ä»½æ‰“å¼€PowerShell**
   ```
   å³é”®"å¼€å§‹"èœå• â†’ é€‰æ‹©"Windows PowerShell(ç®¡ç†å‘˜)"
   ```

3. **åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•**
   ```bash
   cd D:\code\webgis_project\webgis_project
   ```

4. **æ¸…ç†npmç¼“å­˜**
   ```bash
   npm cache clean --force
   ```

5. **å®‰è£…ä¾èµ–**
   ```bash
   npm install jspdf@2.5.2 html2canvas@1.4.1 jspdf-autotable@3.8.3 --save
   ```

6. **éªŒè¯å®‰è£…**
   ```bash
   npm list jspdf html2canvas jspdf-autotable
   ```
   
   åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
   ```
   xinjiang-webgis@1.0.0 D:\code\webgis_project\webgis_project
   â”œâ”€â”€ html2canvas@1.4.1
   â”œâ”€â”€ jspdf@2.5.2
   â””â”€â”€ jspdf-autotable@3.8.3
   ```

#### æ–¹æ³•2ï¼šä¸´æ—¶å…³é—­æ€æ¯’è½¯ä»¶

å¦‚æœæ–¹æ³•1å¤±è´¥ï¼š
1. ä¸´æ—¶å…³é—­Windows Defenderæˆ–å…¶ä»–æ€æ¯’è½¯ä»¶
2. é‡å¤æ–¹æ³•1çš„æ­¥éª¤3-6
3. å®‰è£…å®Œæˆåé‡æ–°å¼€å¯æ€æ¯’è½¯ä»¶

#### æ–¹æ³•3ï¼šæ›´æ”¹npmç¼“å­˜ç›®å½•

```bash
# 1. æŸ¥çœ‹å½“å‰ç¼“å­˜ç›®å½•
npm config get cache

# 2. åˆ›å»ºæ–°çš„ç¼“å­˜ç›®å½•ï¼ˆç¡®ä¿æœ‰å†™å…¥æƒé™ï¼‰
mkdir D:\npm-cache

# 3. æ›´æ”¹npmç¼“å­˜ç›®å½•
npm config set cache "D:\npm-cache"

# 4. é‡æ–°å®‰è£…
npm install jspdf@2.5.2 html2canvas@1.4.1 jspdf-autotable@3.8.3 --save
```

#### å®‰è£…æˆåŠŸåçš„æ“ä½œ

1. **æ›´æ–°package.json**ï¼ˆå·²è‡ªåŠ¨å®Œæˆï¼‰
   ```json
   "dependencies": {
     "html2canvas": "^1.4.1",
     "jspdf": "^2.5.2",
     "jspdf-autotable": "^3.8.3"
   }
   ```

2. **æ¢å¤PDFç”Ÿæˆå™¨æ–‡ä»¶**
   - åˆ›å»º`src/utils/pdfGenerator.js`
   - ä»£ç è§ä¸‹æ–¹é™„å½•

3. **é‡å¯å¼€å‘æœåŠ¡å™¨**
   ```bash
   npm run dev
   ```

---

### 4. æŒ‰é’®åç§°ä¼˜åŒ–

**é—®é¢˜**ï¼š
- "æ—¶é—´è½´ä¸ç»Ÿè®¡"è¿™ä¸ªåç§°ä¸å¤Ÿå‡†ç¡®
- é¡µé¢å®é™…å±•ç¤ºçš„æ˜¯åœ°å›¾å’Œç»Ÿè®¡ä¿¡æ¯ï¼Œæ²¡æœ‰æ—¶é—´è½´

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ”¹åä¸º"åœ°å›¾ä¸ç»Ÿè®¡"
- æ›´æ¢å›¾æ ‡ä¸ºLocationï¼ˆåœ°å›¾å®šä½å›¾æ ‡ï¼‰
- æ–‡ä»¶ï¼š`src/views/ResultCompare/components/TemporalMapViewEnhanced.vue`

**ä¿®æ”¹å†…å®¹**ï¼š
```vue
<!-- ä¿®æ”¹å‰ -->
<el-button>
  <el-icon><Timer /></el-icon>
  æ—¶é—´è½´ä¸ç»Ÿè®¡
</el-button>

<!-- ä¿®æ”¹å -->
<el-button>
  <el-icon><Location /></el-icon>
  åœ°å›¾ä¸ç»Ÿè®¡
</el-button>
```

**ç›¸å…³ä¿®æ”¹**ï¼š
- å¯¼å‡ºæŠ¥å‘Šæ–‡ä»¶åï¼š`æ—¶åºåˆ†ææŠ¥å‘Š_åœ°å›¾ç»Ÿè®¡_YYYY-MM-DD_HH-MM-SS.xls`ï¼ˆåŸæ¥æ˜¯"æ—¶é—´è½´ç»Ÿè®¡"ï¼‰
- æ·»åŠ Locationå›¾æ ‡å¯¼å…¥

**é¡µé¢å®é™…å†…å®¹**ï¼š
1. æ—¶åºå˜åŒ–åœ°å›¾ï¼ˆOpenLayersåœ°å›¾ï¼‰
2. ç»Ÿè®¡ä¿¡æ¯é¢æ¿ï¼ˆæ€»æ•°ã€æœ‰å˜åŒ–ã€æ— å˜åŒ–ã€åŒ¹é…ç‡ï¼‰
3. å˜åŒ–åœ°å—åˆ—è¡¨ï¼ˆæ˜¾ç¤ºèµ·å§‹â†’ç»“æŸä½œç‰©ã€å˜åŒ–åºåˆ—ï¼‰

---

## ğŸ“Š æµ‹è¯•æ£€æŸ¥æ¸…å•

### 1. ä½œç‰©è½¬æ¢æµå‘å›¾
- [ ] æ‰“å¼€"å›¾è¡¨åˆ†æ"Tab
- [ ] æŸ¥çœ‹ä½œç‰©è½¬æ¢æµå‘å›¾
- [ ] ç¡®è®¤é¡¶éƒ¨æœ‰è“è‰²æç¤ºæ¡†ï¼Œæ˜¾ç¤º"å…±ç»Ÿè®¡åˆ° X ç§ä¸åŒçš„ä½œç‰©è½¬æ¢ç±»å‹"
- [ ] å³ä¸Šè§’æ˜¾ç¤º"å…± X æ¬¡å˜åŒ–"
- [ ] åº•éƒ¨ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º"è½¬æ¢ç±»å‹æ•°ï¼šX ç§"

### 2. ä½œç‰©åˆ†å¸ƒè¶‹åŠ¿
- [ ] æŸ¥çœ‹ä½œç‰©åˆ†å¸ƒè¶‹åŠ¿å›¾
- [ ] ç¡®è®¤å·¦ä¾§æ˜¾ç¤º"XXX ä¸ªåœ°å—"è€Œä¸æ˜¯"XXX ä¸ª"
- [ ] åˆ‡æ¢åˆ°"æ•°é‡"æ¨¡å¼ï¼Œè¡¨æ ¼ä¸­æ˜¾ç¤º"XXX ä¸ªåœ°å—"
- [ ] åˆ‡æ¢åˆ°"é¢ç§¯"æ¨¡å¼ï¼Œæ˜¾ç¤º"XXX äº©"
- [ ] åˆ‡æ¢åˆ°"å æ¯”"æ¨¡å¼ï¼Œæ˜¾ç¤º"XX.X%"

### 3. npmåŒ…å®‰è£…ï¼ˆå¦‚éœ€PDFåŠŸèƒ½ï¼‰
- [ ] æŒ‰ç…§ä¸Šè¿°æ–¹æ³•å®‰è£…ä¾èµ–
- [ ] è¿è¡Œ`npm list jspdf`ç¡®è®¤å®‰è£…æˆåŠŸ
- [ ] æ¢å¤pdfGenerator.jsæ–‡ä»¶
- [ ] é‡å¯é¡¹ç›®
- [ ] æµ‹è¯•å¯¼å‡ºæŠ¥å‘ŠåŠŸèƒ½

### 4. æŒ‰é’®åç§°
- [ ] æŸ¥çœ‹æ—¶åºåˆ†æé¡µé¢
- [ ] ç¡®è®¤ç¬¬ä¸€ä¸ªæŒ‰é’®æ˜¾ç¤º"åœ°å›¾ä¸ç»Ÿè®¡"ï¼ˆå¸¦åœ°å›¾å®šä½å›¾æ ‡ï¼‰
- [ ] ç¡®è®¤ç¬¬äºŒä¸ªæŒ‰é’®æ˜¾ç¤º"å›¾è¡¨åˆ†æ"ï¼ˆå¸¦å›¾è¡¨å›¾æ ‡ï¼‰
- [ ] ç‚¹å‡»"åœ°å›¾ä¸ç»Ÿè®¡"ï¼ŒæŸ¥çœ‹åœ°å›¾ã€ç»Ÿè®¡ä¿¡æ¯ã€å˜åŒ–åœ°å—åˆ—è¡¨
- [ ] å¯¼å‡ºæŠ¥å‘Šï¼Œæ–‡ä»¶ååŒ…å«"åœ°å›¾ç»Ÿè®¡"è€Œä¸æ˜¯"æ—¶é—´è½´ç»Ÿè®¡"

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨

1. `src/views/ResultCompare/components/CropTransitionChart.vue`
   - æ·»åŠ äº†è¯´æ˜æç¤ºæ¡†

2. `src/views/ResultCompare/components/CropDistributionChart.vue`
   - ä¿®æ”¹äº†getCropValueå‡½æ•°
   - ä¿®æ”¹äº†getCellValueå‡½æ•°

3. `src/views/ResultCompare/components/TemporalMapViewEnhanced.vue`
   - ä¿®æ”¹äº†æŒ‰é’®åç§°å’Œå›¾æ ‡
   - ä¿®æ”¹äº†å¯¼å‡ºæ–‡ä»¶å
   - æ·»åŠ äº†Locationå›¾æ ‡å¯¼å…¥

---

## é™„å½•ï¼špdfGenerator.jsä»£ç ï¼ˆå¦‚éœ€PDFåŠŸèƒ½ï¼‰

å¦‚æœæˆåŠŸå®‰è£…äº†npmåŒ…ï¼Œå¯ä»¥åˆ›å»º`src/utils/pdfGenerator.js`æ–‡ä»¶ï¼š

```javascript
/**
 * PDFæŠ¥å‘Šç”Ÿæˆå·¥å…·
 * ä½¿ç”¨ jsPDF å’Œ html2canvas ç”ŸæˆåŒ…å«åœ°å›¾å’Œå›¾è¡¨çš„PDFæŠ¥å‘Š
 */

import jsPDF from 'jspdf'
import html2canvas from 'html2canvas'
import 'jspdf-autotable'

/**
 * ç”Ÿæˆæ—¶åºåˆ†æPDFæŠ¥å‘Š
 */
export async function generateTemporalAnalysisPDF(data) {
  try {
    const pdf = new jsPDF('p', 'mm', 'a4')
    const pageWidth = pdf.internal.pageSize.getWidth()
    const pageHeight = pdf.internal.pageSize.getHeight()
    const margin = 15
    let yPosition = margin

    // ========== å°é¢ ==========
    pdf.setFontSize(24)
    pdf.setTextColor(64, 64, 64)
    pdf.text('æ—¶åºå˜åŒ–åˆ†ææŠ¥å‘Š', pageWidth / 2, 40, { align: 'center' })

    pdf.setFontSize(12)
    pdf.setTextColor(100, 100, 100)
    const createTime = data.metadata?.createTime || new Date().toLocaleString('zh-CN')
    pdf.text(`ç”Ÿæˆæ—¶é—´: ${createTime}`, pageWidth / 2, 55, { align: 'center' })

    // åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯æ¡†
    pdf.setDrawColor(64, 158, 255)
    pdf.setLineWidth(1)
    pdf.rect(margin, 70, pageWidth - 2 * margin, 60)

    pdf.setFontSize(14)
    pdf.setTextColor(64, 64, 64)
    yPosition = 85
    pdf.text(`åˆ†ææ—¶é—´æ®µ: ${data.metadata?.timeRange || ''}`, margin + 10, yPosition)
    yPosition += 12
    pdf.text(`æ€»åœ°å—æ•°: ${data.stats?.total || 0} ä¸ªåœ°å—`, margin + 10, yPosition)
    yPosition += 12
    pdf.text(`æœ‰å˜åŒ–: ${data.stats?.changed || 0} ä¸ªåœ°å—`, margin + 10, yPosition)
    yPosition += 12
    pdf.text(`æ— å˜åŒ–: ${data.stats?.unchanged || 0} ä¸ªåœ°å—`, margin + 10, yPosition)
    yPosition += 12
    const changeRate = data.stats?.total > 0 
      ? ((data.stats.changed / data.stats.total) * 100).toFixed(2) 
      : 0
    pdf.text(`å˜åŒ–ç‡: ${changeRate}%`, margin + 10, yPosition)

    // ========== ç¬¬äºŒé¡µï¼šåœ°å›¾æˆªå›¾ ==========
    pdf.addPage()
    yPosition = margin

    pdf.setFontSize(16)
    pdf.setTextColor(64, 64, 64)
    pdf.text('æ—¶åºå˜åŒ–åœ°å›¾', margin, yPosition)
    yPosition += 10

    // æˆªå–åœ°å›¾
    const mapElement = document.getElementById('temporal-map')
    if (mapElement) {
      try {
        const canvas = await html2canvas(mapElement, {
          useCORS: true,
          allowTaint: true,
          scale: 2,
          logging: false
        })
        
        const imgData = canvas.toDataURL('image/png')
        const imgWidth = pageWidth - 2 * margin
        const imgHeight = (canvas.height * imgWidth) / canvas.width
        const maxHeight = pageHeight - yPosition - margin - 20
        const finalHeight = Math.min(imgHeight, maxHeight)
        const finalWidth = (canvas.width * finalHeight) / canvas.height
        
        pdf.addImage(imgData, 'PNG', margin, yPosition, finalWidth, finalHeight)
        yPosition += finalHeight + 10
      } catch (error) {
        console.error('åœ°å›¾æˆªå›¾å¤±è´¥:', error)
        pdf.setFontSize(12)
        pdf.setTextColor(200, 0, 0)
        pdf.text('åœ°å›¾æˆªå›¾å¤±è´¥', margin, yPosition)
      }
    }

    // ========== ç¬¬ä¸‰é¡µï¼šä½œç‰©åˆ†å¸ƒç»Ÿè®¡è¡¨ ==========
    pdf.addPage()
    yPosition = margin

    pdf.setFontSize(16)
    pdf.setTextColor(64, 64, 64)
    pdf.text('ä½œç‰©åˆ†å¸ƒç»Ÿè®¡', margin, yPosition)
    yPosition += 10

    if (data.cropDistribution && data.cropDistribution.length > 0) {
      const tableData = []
      data.cropDistribution.forEach((dist, index) => {
        const timeName = dist.taskName || `æ—¶é—´ç‚¹${index + 1}`
        dist.crops.forEach(crop => {
          tableData.push([
            timeName,
            crop.crop || 'æœªçŸ¥',
            `${crop.count || 0} ä¸ªåœ°å—`,
            `${crop.percentage || 0}%`
          ])
        })
      })

      pdf.autoTable({
        startY: yPosition,
        head: [['æ—¶é—´ç‚¹', 'ä½œç‰©ç±»å‹', 'åœ°å—æ•°é‡', 'å æ¯”']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [64, 158, 255], textColor: 255, fontSize: 10 },
        bodyStyles: { fontSize: 9 },
        alternateRowStyles: { fillColor: [245, 247, 250] },
        margin: { left: margin, right: margin }
      })

      yPosition = pdf.lastAutoTable.finalY + 10
    }

    // ========== ç¬¬å››é¡µï¼šå˜åŒ–åœ°å—è¯¦æƒ… ==========
    pdf.addPage()
    yPosition = margin

    pdf.setFontSize(16)
    pdf.setTextColor(64, 64, 64)
    pdf.text('å˜åŒ–åœ°å—è¯¦æƒ…', margin, yPosition)
    yPosition += 10

    const changedFeatures = (data.features || []).filter(f => (f.properties?.changeCount || 0) > 0)
    
    if (changedFeatures.length > 0) {
      const tableData = changedFeatures.slice(0, 50).map((feature, index) => [
        index + 1,
        feature.properties?.id || '-',
        feature.properties?.plotName || 'æœªå‘½å',
        feature.properties?.startCrop || '-',
        feature.properties?.endCrop || '-',
        `${feature.properties?.changeCount || 0} æ¬¡`,
        feature.properties?.cropSequence || '-'
      ])

      pdf.autoTable({
        startY: yPosition,
        head: [['åºå·', 'åœ°å—ID', 'åœ°å—åç§°', 'èµ·å§‹ä½œç‰©', 'ç»“æŸä½œç‰©', 'å˜åŒ–æ¬¡æ•°', 'å˜åŒ–åºåˆ—']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [64, 158, 255], textColor: 255, fontSize: 9 },
        bodyStyles: { fontSize: 8 },
        alternateRowStyles: { fillColor: [245, 247, 250] },
        columnStyles: {
          6: { cellWidth: 40 }
        },
        margin: { left: margin, right: margin }
      })
    }

    // ========== é¡µè„š ==========
    const totalPages = pdf.internal.getNumberOfPages()
    for (let i = 1; i <= totalPages; i++) {
      pdf.setPage(i)
      pdf.setFontSize(9)
      pdf.setTextColor(150, 150, 150)
      pdf.text(
        `ç¬¬ ${i} é¡µ / å…± ${totalPages} é¡µ`,
        pageWidth / 2,
        pageHeight - 10,
        { align: 'center' }
      )
    }

    return pdf.output('blob')
  } catch (error) {
    console.error('PDFç”Ÿæˆå¤±è´¥:', error)
    throw error
  }
}

/**
 * ä¸‹è½½PDFæ–‡ä»¶
 */
export function downloadPDF(blob, filename) {
  const link = document.createElement('a')
  const url = URL.createObjectURL(blob)
  link.href = url
  link.download = filename
  link.style.display = 'none'
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  URL.revokeObjectURL(url)
}
```

---

**ä¿®å¤æ—¶é—´**ï¼š2025-10-20  
**ä¿®æ”¹æ–‡ä»¶**ï¼š3ä¸ª  
**åŠŸèƒ½çŠ¶æ€**ï¼š
- âœ… ä½œç‰©è½¬æ¢æµå‘å›¾è¯´æ˜ - å·²æ·»åŠ 
- âœ… ä½œç‰©åˆ†å¸ƒè¶‹åŠ¿å•ä½ - å·²ä¿®å¤  
- â¸ï¸ npmåŒ…å®‰è£… - éœ€ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
- âœ… æŒ‰é’®åç§°ä¼˜åŒ– - å·²å®Œæˆ



