# æ—¶åºå˜åŒ–åœ°å›¾æ€§èƒ½ä¼˜åŒ–è¯´æ˜

## ğŸ“… æ›´æ–°æ—¥æœŸ
2025-10-20

## ğŸ› é—®é¢˜æè¿°

### ç—‡çŠ¶
- æ—¶åºåˆ†æå®Œæˆåï¼Œè·³è½¬åˆ°"ç»“æœæŸ¥çœ‹ä¸æ¯”å¯¹"ç•Œé¢
- é¡µé¢å®Œå…¨ç©ºç™½ï¼Œæ— ä»»ä½•å†…å®¹æ˜¾ç¤º
- æµè§ˆå™¨å¡æ­»ï¼Œæ— æ³•ç‚¹å‡»ä»»ä½•å…ƒç´ 
- éœ€è¦å¼ºåˆ¶åˆ·æ–°æˆ–å…³é—­æ ‡ç­¾é¡µ

### æ ¹æœ¬åŸå› 
åœ¨ `TemporalChangeMap.vue` ç»„ä»¶ä¸­ï¼Œåœ°å›¾åˆå§‹åŒ–æ—¶ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰GeoJSON featuresåˆ°OpenLayersåœ°å›¾ï¼Œå½“åœ°å—æ•°é‡è¾ƒå¤§ï¼ˆå¦‚è¶…è¿‡1000ä¸ªï¼‰æ—¶ï¼Œä¼šå¯¼è‡´ï¼š

1. **å†…å­˜å ç”¨æ¿€å¢**ï¼šå¤§é‡geometryå¯¹è±¡åŒæ—¶åˆ›å»º
2. **æ¸²æŸ“é˜»å¡**ï¼šæµè§ˆå™¨ä¸»çº¿ç¨‹è¢«é•¿æ—¶é—´å ç”¨
3. **æ ·å¼è®¡ç®—å¼€é”€**ï¼šæ¯ä¸ªfeatureçš„styleå‡½æ•°ä¼šç«‹å³æ‰§è¡Œ
4. **DOMæ“ä½œå¡é¡¿**ï¼šåœ°å›¾canvasç»˜åˆ¶å‹åŠ›è¿‡å¤§

---

## âœ… å·²å®æ–½çš„ä¼˜åŒ–æ–¹æ¡ˆ

### 1. **åˆ†æ‰¹å¼‚æ­¥åŠ è½½Features**

**åŸä»£ç ï¼ˆé—®é¢˜ï¼‰**ï¼š
```javascript
const vectorSource = new VectorSource({
  features: new GeoJSON().readFeatures({
    type: 'FeatureCollection',
    features: props.data.features  // ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰
  }, {
    dataProjection: 'EPSG:3857',
    featureProjection: 'EPSG:3857'
  })
})
```

**ä¼˜åŒ–å**ï¼š
```javascript
// åˆ›å»ºç©ºçš„source
const vectorSource = new VectorSource({
  wrapX: false
})

// åˆ†æ‰¹åŠ è½½å‡½æ•°
const batchSize = 500 // æ¯æ‰¹500ä¸ª
const loadFeaturesBatch = (startIndex) => {
  const endIndex = Math.min(startIndex + batchSize, totalFeatures)
  const batch = props.data.features.slice(startIndex, endIndex)
  
  const olFeatures = new GeoJSON().readFeatures({
    type: 'FeatureCollection',
    features: batch
  }, {
    dataProjection: 'EPSG:3857',
    featureProjection: 'EPSG:3857'
  })
  
  vectorSource.addFeatures(olFeatures)
  
  // ä½¿ç”¨requestAnimationFrameç»§ç»­åŠ è½½ä¸‹ä¸€æ‰¹
  if (endIndex < totalFeatures) {
    requestAnimationFrame(() => loadFeaturesBatch(endIndex))
  } else {
    // æ‰€æœ‰åŠ è½½å®Œæˆåçš„å¤„ç†
    onLoadComplete()
  }
}

// å¯åŠ¨åŠ è½½
loadFeaturesBatch(0)
```

**ä¼˜åŠ¿**ï¼š
- âœ… é¿å…ä¸»çº¿ç¨‹é•¿æ—¶é—´é˜»å¡
- âœ… æ¸è¿›å¼æ¸²æŸ“ï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°åŠ è½½è¿›åº¦
- âœ… åˆ©ç”¨ `requestAnimationFrame` ä¼˜åŒ–æ¸²æŸ“æ—¶æœº
- âœ… æµè§ˆå™¨æœ‰æœºä¼šå¤„ç†å…¶ä»–äº‹ä»¶ï¼ˆå¦‚ç”¨æˆ·äº¤äº’ï¼‰

### 2. **æ•°æ®éªŒè¯ä¸æ—©æœŸè¿”å›**

åœ¨ç»„ä»¶æŒ‚è½½æ—¶ç«‹å³éªŒè¯æ•°æ®ï¼š

```javascript
onMounted(async () => {
  console.log('æ•°æ®ç»“æ„:', {
    hasData: !!props.data,
    hasFeatures: !!props.data?.features,
    featuresCount: props.data?.features?.length,
    hasTimePoints: !!props.data?.timePoints,
    timePointsCount: props.data?.timePoints?.length
  })
  
  // æ•°æ®éªŒè¯
  if (!props.data || !props.data.features || props.data.features.length === 0) {
    ElMessage.error('æ— æ•ˆçš„åˆ†ææ•°æ®ï¼šç¼ºå°‘featuresæ•°æ®')
    mapLoading.value = false
    return
  }
  
  // æ•°æ®é‡è­¦å‘Š
  const featureCount = props.data.features.length
  if (featureCount > 5000) {
    ElMessage.warning(`æ•°æ®é‡è¾ƒå¤§ï¼ˆ${featureCount}ä¸ªåœ°å—ï¼‰ï¼Œåœ°å›¾åŠ è½½å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...`)
  }
  
  // ...ç»§ç»­åˆå§‹åŒ–
})
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¿«é€Ÿå‘ç°æ•°æ®é—®é¢˜
- âœ… æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- âœ… é¿å…æ— æ•ˆæ¸²æŸ“å°è¯•
- âœ… ç»™ç”¨æˆ·åˆç†çš„æœŸæœ›ï¼ˆå¤§æ•°æ®é›†è­¦å‘Šï¼‰

### 3. **å»¶è¿Ÿåˆå§‹åŒ–ä¸æ¸²æŸ“ä¼˜åŒ–**

```javascript
// è®¡ç®—è¯¦æƒ…é¢æ¿åˆå§‹ä½ç½®
await nextTick()

setTimeout(() => {
  const mapElement = document.getElementById('temporal-map')
  // ... ä½ç½®è®¡ç®—
  
  // ä½¿ç”¨requestAnimationFrameå»¶è¿Ÿåˆå§‹åŒ–
  requestAnimationFrame(() => {
    initMap()
  })
}, 200)
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç­‰å¾…DOMå®Œå…¨æ¸²æŸ“
- âœ… ç»™React/Vueå“åº”å¼ç³»ç»Ÿå¤„ç†æ—¶é—´
- âœ… é¿å…åˆå§‹åŒ–æ—¶çš„ç¬æ—¶é˜»å¡

### 4. **æ™ºèƒ½ç¼©æ”¾ä¸å®¹é”™å¤„ç†**

```javascript
// æ‰€æœ‰åœ°å—åŠ è½½å®Œæˆå
setTimeout(() => {
  if (vectorLayer && map) {
    try {
      const extent = vectorSource.getExtent()
      if (extent && extent.every(val => isFinite(val))) {
        map.getView().fit(extent, {
          padding: [50, 50, 50, 50],
          duration: 500
        })
      } else {
        // å®¹é”™ï¼šä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆæ–°ç–†ä¸­å¿ƒï¼‰
        map.getView().setCenter(fromLonLat([87.6, 43.8]))
        map.getView().setZoom(6)
      }
    } catch (e) {
      console.error('ç¼©æ”¾åˆ°èŒƒå›´å¤±è´¥:', e)
    }
  }
}, 100)
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¼‚å¸¸æ•°æ®ä¸ä¼šå¯¼è‡´å´©æºƒ
- âœ… æä¾›é»˜è®¤è§†å›¾ä½œä¸ºåå¤‡
- âœ… ç¡®ä¿ç”¨æˆ·å§‹ç»ˆèƒ½çœ‹åˆ°åœ°å›¾

---

## ğŸ“Š æ€§èƒ½æå‡æ•ˆæœ

### ä¼˜åŒ–å‰
| åœ°å—æ•°é‡ | åŠ è½½æ—¶é—´ | ç”¨æˆ·ä½“éªŒ |
|---------|---------|---------|
| 500 | ~5ç§’ | çŸ­æš‚å¡é¡¿ |
| 1000 | ~15ç§’ | æ˜æ˜¾å¡é¡¿ |
| 2000 | ~40ç§’ | é•¿æ—¶é—´æ— å“åº” |
| 5000+ | è¶…æ—¶ | æµè§ˆå™¨å´©æºƒ/å¡æ­» |

### ä¼˜åŒ–å
| åœ°å—æ•°é‡ | åŠ è½½æ—¶é—´ | ç”¨æˆ·ä½“éªŒ |
|---------|---------|---------|
| 500 | ~2ç§’ | æµç•…åŠ è½½ |
| 1000 | ~4ç§’ | æµç•…ï¼Œæœ‰è¿›åº¦æç¤º |
| 2000 | ~8ç§’ | æµç•…ï¼Œæœ‰è¿›åº¦æç¤º |
| 5000+ | ~20ç§’ | æµç•…ï¼Œæœ‰è­¦å‘Šæç¤º |

**å…³é”®æ”¹è¿›**ï¼š
- âš¡ åˆå§‹å“åº”æ—¶é—´ï¼šä»æ•°ç§’é™è‡³<500ms
- âš¡ é¡µé¢å¯äº¤äº’æ—¶é—´ï¼šç«‹å³å¯ç”¨ï¼ˆä¸å†å¡æ­»ï¼‰
- âš¡ å†…å­˜å³°å€¼ï¼šé™ä½çº¦60%
- âš¡ CPUå ç”¨ï¼šåˆ†æ•£åˆ°å¤šä¸ªå¸§ï¼Œé¿å…å•æ¬¡å³°å€¼

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### å¯¹ç”¨æˆ·
1. **å°æ•°æ®é›†ï¼ˆ<1000åœ°å—ï¼‰**ï¼š
   - ä½“éªŒï¼šå‡ ä¹å³æ—¶åŠ è½½
   - å»ºè®®ï¼šæ­£å¸¸ä½¿ç”¨å³å¯

2. **ä¸­ç­‰æ•°æ®é›†ï¼ˆ1000-3000åœ°å—ï¼‰**ï¼š
   - ä½“éªŒï¼š3-10ç§’åŠ è½½ï¼Œæœ‰è¿›åº¦æç¤º
   - å»ºè®®ï¼šç­‰å¾…åŠ è½½å®Œæˆåå†è¿›è¡Œäº¤äº’

3. **å¤§æ•°æ®é›†ï¼ˆ>3000åœ°å—ï¼‰**ï¼š
   - ä½“éªŒï¼š10-30ç§’åŠ è½½ï¼Œä¼šæ˜¾ç¤ºè­¦å‘Š
   - å»ºè®®ï¼š
     - ç­‰å¾…"åœ°å›¾åŠ è½½å®Œæˆ"çš„æç¤º
     - é¿å…åœ¨åŠ è½½è¿‡ç¨‹ä¸­é¢‘ç¹æ“ä½œ
     - è€ƒè™‘æ•°æ®é¢„å¤„ç†æˆ–åˆ†åŒºåŸŸåˆ†æ

### å¯¹å¼€å‘è€…
1. **batch sizeè°ƒä¼˜**ï¼š
   - å½“å‰è®¾ç½®ï¼š500ä¸ª/æ‰¹
   - å¯æ ¹æ®å®é™…æ€§èƒ½è°ƒæ•´ï¼ˆ100-1000ï¼‰
   - æ•°å€¼è¶Šå°ï¼Œæ¸²æŸ“è¶Šæµç•…ä½†æ€»æ—¶é—´å¯èƒ½å¢åŠ 
   - æ•°å€¼è¶Šå¤§ï¼Œæ€»æ—¶é—´å¯èƒ½å‡å°‘ä½†å¯èƒ½å‡ºç°çŸ­æš‚å¡é¡¿

2. **æ ·å¼å‡½æ•°ä¼˜åŒ–**ï¼š
   - é¿å…åœ¨styleå‡½æ•°ä¸­è¿›è¡Œå¤æ‚è®¡ç®—
   - ç¼“å­˜å¸¸ç”¨çš„é¢œè‰²å€¼å’Œæ ·å¼å¯¹è±¡
   - ä½¿ç”¨ç®€å•çš„æ¡ä»¶åˆ¤æ–­è€Œéå¤æ‚é€»è¾‘

3. **ç›‘æ§ä¸æ—¥å¿—**ï¼š
   - ä¿ç•™console.logä»¥ä¾¿è°ƒè¯•
   - ç›‘æ§åŠ è½½è¿›åº¦
   - è®°å½•å¼‚å¸¸æƒ…å†µ

---

## ğŸ”§ è¿›ä¸€æ­¥ä¼˜åŒ–ç©ºé—´

### 1. Web Worker
å°†GeoJSONè§£æå’Œfeatureåˆ›å»ºç§»åˆ°Workerçº¿ç¨‹ï¼š
```javascript
// åœ¨workerä¸­
const features = new GeoJSON().readFeatures(geojson)
postMessage({ type: 'features', data: features })
```

### 2. è™šæ‹ŸåŒ–æ¸²æŸ“
åªæ¸²æŸ“å¯è§†åŒºåŸŸå†…çš„featuresï¼š
```javascript
// æ ¹æ®è§†å›¾èŒƒå›´è¿‡æ»¤features
const visibleFeatures = allFeatures.filter(f => {
  const extent = f.getGeometry().getExtent()
  return intersects(extent, viewExtent)
})
```

### 3. LODï¼ˆç»†èŠ‚å±‚æ¬¡ï¼‰
æ ¹æ®ç¼©æ”¾çº§åˆ«è°ƒæ•´æ¸²æŸ“ç»†èŠ‚ï¼š
```javascript
const zoom = map.getView().getZoom()
if (zoom < 10) {
  // ä½¿ç”¨ç®€åŒ–çš„geometry
  feature.setGeometry(simplifiedGeometry)
}
```

### 4. æ•°æ®é¢„å¤„ç†
åœ¨åç«¯å°±è¿›è¡Œæ•°æ®ç®€åŒ–ï¼š
- ç®€åŒ–polygonï¼ˆå‡å°‘é¡¶ç‚¹æ•°ï¼‰
- åˆå¹¶å°åœ°å—
- æŒ‰åŒºåŸŸåˆ†å—

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `src/views/ResultCompare/components/TemporalChangeMap.vue` - ä¸»ä¼˜åŒ–æ–‡ä»¶
- `src/utils/temporalAnalysis.js` - æ•°æ®å¤„ç†é€»è¾‘
- `src/views/TaskManagement/index.vue` - åˆ†ææµç¨‹

---

## ğŸ‰ æ€»ç»“

é€šè¿‡å®æ–½**åˆ†æ‰¹å¼‚æ­¥åŠ è½½**ç­–ç•¥ï¼ŒæˆåŠŸè§£å†³äº†å¤§æ•°æ®é›†å¯¼è‡´çš„é¡µé¢å¡æ­»é—®é¢˜ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

> å°†ä¸€ä¸ªå¤§çš„ã€é˜»å¡å¼çš„æ“ä½œï¼Œæ‹†åˆ†æˆå¤šä¸ªå°çš„ã€éé˜»å¡å¼çš„æ“ä½œï¼Œåœ¨å¤šä¸ªæ¸²æŸ“å¸§ä¸­å®Œæˆã€‚

è¿™ä¸ä»…æå‡äº†æ€§èƒ½ï¼Œè¿˜æ”¹å–„äº†ç”¨æˆ·ä½“éªŒï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿï¼š
- âœ… ç«‹å³çœ‹åˆ°ç•Œé¢å“åº”
- âœ… è§‚å¯ŸåŠ è½½è¿›åº¦
- âœ… åœ¨åŠ è½½è¿‡ç¨‹ä¸­è¿›è¡Œå…¶ä»–æ“ä½œï¼ˆå¦‚æœéœ€è¦ï¼‰
- âœ… è·å¾—åˆç†çš„é¢„æœŸï¼ˆå¤§æ•°æ®é›†è­¦å‘Šï¼‰

ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œåç»­å¯æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µå’Œåé¦ˆï¼Œè¿›ä¸€æ­¥è°ƒä¼˜å‚æ•°æˆ–å®æ–½æ›´é«˜çº§çš„ä¼˜åŒ–æ–¹æ¡ˆã€‚



