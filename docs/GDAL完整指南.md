# GDALå®Œæ•´é…ç½®ä¸æ•…éšœæ’é™¤æŒ‡å—

> æœ¬æ–‡æ¡£æ•´åˆäº†GDALçš„å®‰è£…ã€é…ç½®ã€æ•…éšœæ’é™¤å’Œè‡ªå®šä¹‰condaç¯å¢ƒçš„æ‰€æœ‰å†…å®¹ã€‚

---

## ğŸ“– ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [è¯¦ç»†å®‰è£…æ­¥éª¤](#è¯¦ç»†å®‰è£…æ­¥éª¤)
3. [é…ç½®é¡¹ç›®](#é…ç½®é¡¹ç›®)
4. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
5. [è‡ªå®šä¹‰Condaç¯å¢ƒ](#è‡ªå®šä¹‰condaç¯å¢ƒ)
6. [éªŒè¯ä¸æµ‹è¯•](#éªŒè¯ä¸æµ‹è¯•)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æœ€ç®€3æ­¥é…ç½®

```bash
# 1. æ‰“å¼€ Anaconda Prompt
# 2. å®‰è£…GDAL
conda activate xm  # æˆ–ä½ çš„ç¯å¢ƒå
conda install -c conda-forge gdal

# 3. éªŒè¯å®‰è£…
gdalinfo --version
```

ç„¶ååœ¨ `server/config.js` ä¸­é…ç½®ä½ çš„condaç¯å¢ƒåï¼š

```javascript
export default {
  condaEnv: 'xm',  // æ”¹æˆä½ çš„ç¯å¢ƒå
}
```

---

## ğŸ“¦ è¯¦ç»†å®‰è£…æ­¥éª¤

### æ–¹æ³•1ï¼šåœ¨ç°æœ‰ç¯å¢ƒä¸­å®‰è£…ï¼ˆæ¨èï¼‰

```bash
# 1. æ¿€æ´»ä½ çš„ç¯å¢ƒ
conda activate your_env_name

# 2. å®‰è£…GDAL
conda install -c conda-forge gdal

# 3. éªŒè¯
gdalinfo --version
```

### æ–¹æ³•2ï¼šåˆ›å»ºæ–°çš„ä¸“ç”¨ç¯å¢ƒ

```bash
# 1. åˆ›å»ºæ–°ç¯å¢ƒ
conda create -n gdal_env python=3.9

# 2. æ¿€æ´»ç¯å¢ƒ
conda activate gdal_env

# 3. å®‰è£…GDAL
conda install -c conda-forge gdal

# 4. å®‰è£…Node.jsä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
conda install nodejs
```

### æ–¹æ³•3ï¼šä½¿ç”¨ç³»ç»ŸPATHï¼ˆä¸æ¨èï¼‰

å¦‚æœä½ å¸Œæœ›GDALåœ¨ç³»ç»ŸPATHä¸­ï¼š

```bash
# 1. å®‰è£…åˆ°baseç¯å¢ƒ
conda activate base
conda install -c conda-forge gdal

# 2. æ·»åŠ åˆ°ç³»ç»ŸPATHï¼ˆWindowsï¼‰
# æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ï¼šC:\Users\YourName\anaconda3\Library\bin
```

---

## âš™ï¸ é…ç½®é¡¹ç›®

### 1. é…ç½®Condaç¯å¢ƒå

ç¼–è¾‘ `server/config.js`ï¼š

```javascript
export default {
  // Condaç¯å¢ƒåç§°ï¼Œå¦‚æœGDALå®‰è£…åœ¨condaç¯å¢ƒä¸­ï¼Œè¯·åœ¨æ­¤å¤„å¡«å†™ç¯å¢ƒåç§°
  // ä¾‹å¦‚ï¼š'base', 'myenv', 'gdal_env'
  // å¦‚æœGDALå·²æ·»åŠ åˆ°ç³»ç»ŸPATHï¼Œå¯ä»¥è®¾ç½®ä¸º null
  condaEnv: 'xm',  // ğŸ‘ˆ æ”¹æˆä½ çš„ç¯å¢ƒå
  
  // å…¶ä»–é…ç½®...
}
```

### 2. åœ¨Anaconda Promptä¸­å¯åŠ¨åç«¯

**é‡è¦ï¼šå¿…é¡»åœ¨Anaconda Promptä¸­å¯åŠ¨ï¼Œè€Œä¸æ˜¯æ™®é€šCMDï¼**

```bash
# 1. æ‰“å¼€ Anaconda Promptï¼ˆä¸æ˜¯æ™®é€šCMDï¼‰
# 2. æ¿€æ´»ç¯å¢ƒ
conda activate xm

# 3. è¿›å…¥é¡¹ç›®ç›®å½•
cd D:\code\å‰ç«¯å­¦ä¹ ä¹‹è·¯\demo\demo07

# 4. å¯åŠ¨åç«¯
cd server
npm run dev
```

å¦‚æœæˆåŠŸï¼Œä½ ä¼šçœ‹åˆ°ï¼š

```
âœ… GDALå·²å®‰è£…: GDAL 3.8.0, released 2023/11/16
   ä½¿ç”¨Condaç¯å¢ƒ: xm
æœåŠ¡å™¨å·²å¯åŠ¨: http://localhost:8080
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### âŒ é—®é¢˜1ï¼šGDALæ£€æµ‹å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
âŒ GDALæ£€æµ‹å¤±è´¥: Command failed...
æœåŠ¡å™¨æœªæ£€æµ‹åˆ°GDALï¼Œè¯·æ£€æŸ¥é…ç½®
```

**åŸå› åˆ†æï¼š**

#### åŸå› 1ï¼šcondaå‘½ä»¤ä¸åœ¨PATHä¸­

**è§£å†³æ–¹æ¡ˆï¼š**
- âœ… **åœ¨Anaconda Promptä¸­å¯åŠ¨åç«¯**ï¼ˆè€Œä¸æ˜¯æ™®é€šCMDï¼‰
- Anaconda Promptä¼šè‡ªåŠ¨é…ç½®condaå‘½ä»¤

**éªŒè¯æ–¹æ³•ï¼š**
```bash
# åœ¨ä½ çš„ç»ˆç«¯ä¸­è¿è¡Œ
where conda
# åº”è¯¥æ˜¾ç¤ºï¼šC:\Users\...\anaconda3\Scripts\conda.exe

# å¦‚æœæ˜¾ç¤º"æ‰¾ä¸åˆ°"ï¼Œè¯´æ˜ä½ åœ¨æ™®é€šCMDä¸­ï¼Œéœ€è¦åˆ‡æ¢åˆ°Anaconda Prompt
```

#### åŸå› 2ï¼šç¯å¢ƒåç§°ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. æŸ¥çœ‹æ‰€æœ‰condaç¯å¢ƒ
conda env list

# è¾“å‡ºç¤ºä¾‹ï¼š
# base                  *  C:\Users\...\anaconda3
# xm                       C:\Users\...\anaconda3\envs\xm
# myenv                    C:\Users\...\anaconda3\envs\myenv

# 2. ä¿®æ”¹ server/config.js ä¸­çš„ condaEnv ä¸ºå®é™…çš„ç¯å¢ƒå
```

#### åŸå› 3ï¼šGDALæœªåœ¨è¯¥ç¯å¢ƒä¸­å®‰è£…

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. æ¿€æ´»ç¯å¢ƒ
conda activate xm

# 2. æ£€æŸ¥GDALæ˜¯å¦å·²å®‰è£…
gdalinfo --version

# å¦‚æœæ˜¾ç¤ºé”™è¯¯ï¼Œè¯´æ˜æœªå®‰è£…ï¼Œæ‰§è¡Œï¼š
conda install -c conda-forge gdal
```

#### åŸå› 4ï¼šåç«¯åœ¨æ™®é€šCMDä¸­å¯åŠ¨

**è§£å†³æ–¹æ¡ˆï¼š**
1. å…³é—­å½“å‰CMDçª—å£
2. æ‰“å¼€ **Anaconda Prompt**
3. é‡æ–°å¯åŠ¨åç«¯

---

### âŒ é—®é¢˜2ï¼šç«¯å£è¢«å ç”¨ï¼ˆEADDRINUSEï¼‰

**ç—‡çŠ¶ï¼š**
```
Error: listen EADDRINUSE: address already in use :::8080
```

**åŸå› ï¼š** 8080ç«¯å£è¢«å…¶ä»–ç¨‹åºå ç”¨

**è§£å†³æ–¹æ¡ˆï¼š**

**æ–¹æ³•1ï¼šæ€æ­»å ç”¨è¿›ç¨‹**
```bash
# Windows
netstat -ano | findstr :8080
taskkill /PID <PID> /F

# æˆ–ç›´æ¥æ€æ­»æ‰€æœ‰Nodeè¿›ç¨‹
taskkill /F /IM node.exe
```

**æ–¹æ³•2ï¼šæ›´æ”¹ç«¯å£**

ç¼–è¾‘ `server/app.js`ï¼Œä¿®æ”¹ç«¯å£å·ï¼š
```javascript
const PORT = 8081  // æ”¹æˆå…¶ä»–ç«¯å£
```

---

### âŒ é—®é¢˜3ï¼šä¼˜åŒ–è¶…æ—¶ï¼ˆtimeout exceededï¼‰

**ç—‡çŠ¶ï¼š**
```
AxiosError: timeout of 300000ms exceeded
```

**åŸå› ï¼š** å¤§æ–‡ä»¶ï¼ˆ70MB+ï¼‰ä¼˜åŒ–éœ€è¦è¶…è¿‡5åˆ†é’Ÿ

**è§£å†³æ–¹æ¡ˆï¼š**

å·²åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­ä¿®å¤ï¼Œè¶…æ—¶æ—¶é—´å·²å¢åŠ åˆ°15åˆ†é’Ÿï¼š
- å‰ç«¯ï¼š`src/api/index.js` â†’ `timeout: 900000`ï¼ˆ15åˆ†é’Ÿï¼‰
- åç«¯ï¼š`server/routes/image.js` â†’ `req.setTimeout(15 * 60 * 1000)`

**å¦‚æœè¿˜æ˜¯è¶…æ—¶ï¼š**
1. æ£€æŸ¥ä»»åŠ¡ç®¡ç†å™¨ï¼Œç¡®è®¤ `gdalwarp.exe` æ˜¯å¦åœ¨è¿è¡Œ
2. ç­‰å¾…æ›´é•¿æ—¶é—´ï¼ˆ70MBæ–‡ä»¶å¯èƒ½éœ€è¦10-15åˆ†é’Ÿï¼‰
3. ä½¿ç”¨æ‰‹åŠ¨è„šæœ¬ `optimize_tif.bat`

---

### âŒ é—®é¢˜4ï¼šæ–‡ä»¶IDé‡å¤

**ç—‡çŠ¶ï¼š** å¤šä¸ªæ–‡ä»¶æ˜¾ç¤ºç›¸åŒçš„çŠ¶æ€

**åŸå› ï¼š** ä¹‹å‰çš„IDç”Ÿæˆé€»è¾‘æœ‰bug

**è§£å†³æ–¹æ¡ˆï¼š** å·²ä¿®å¤ï¼ˆè‡ªåŠ¨æ‰¾æœ€å¤§ID+1ï¼‰

å¦‚æœä»æœ‰é—®é¢˜ï¼š
```bash
# æ‰‹åŠ¨é‡ç½®å…ƒæ•°æ®
del public\data\imageData.json
# é‡å¯åç«¯ï¼Œä¼šè‡ªåŠ¨é‡æ–°ç”Ÿæˆ
```

---

## ğŸ¯ è‡ªå®šä¹‰Condaç¯å¢ƒ

### ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ç¯å¢ƒåï¼Ÿ

**åœºæ™¯ï¼š** ä¸åŒå¼€å‘è€…çš„condaç¯å¢ƒåç§°ä¸åŒ

| å¼€å‘è€… | ç¯å¢ƒå | é…ç½® |
|--------|--------|------|
| å¼ ä¸‰ | `xm` | `condaEnv: 'xm'` |
| æå›› | `base` | `condaEnv: 'base'` |
| ç‹äº” | `gis_env` | `condaEnv: 'gis_env'` |

### é…ç½®æ­¥éª¤

**Step 1ï¼šæŸ¥çœ‹ä½ çš„ç¯å¢ƒå**
```bash
conda env list
```

**Step 2ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶**

ç¼–è¾‘ `server/config.js`ï¼š
```javascript
export default {
  condaEnv: 'your_env_name',  // æ”¹æˆä½ çš„ç¯å¢ƒå
}
```

**Step 3ï¼šé‡å¯åç«¯**
```bash
# åœ¨Anaconda Promptä¸­
conda activate your_env_name
cd server
npm run dev
```

### å›¢é˜Ÿåä½œå»ºè®®

**æ–¹æ¡ˆ1ï¼šä½¿ç”¨ç»Ÿä¸€ç¯å¢ƒåï¼ˆæ¨èï¼‰**
- å›¢é˜Ÿçº¦å®šä½¿ç”¨ `gdal_env`
- æ¯ä¸ªäººéƒ½åˆ›å»ºè¿™ä¸ªç¯å¢ƒï¼š
  ```bash
  conda create -n gdal_env python=3.9
  conda activate gdal_env
  conda install -c conda-forge gdal
  ```

**æ–¹æ¡ˆ2ï¼šé…ç½®æ–‡ä»¶ä¸ªæ€§åŒ–**
- å°† `server/config.js` æ·»åŠ åˆ° `.gitignore`
- æ¯ä¸ªäººä½¿ç”¨è‡ªå·±çš„é…ç½®
- æä¾› `server/config.example.js` ä½œä¸ºæ¨¡æ¿

**æ–¹æ¡ˆ3ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡**
```javascript
// server/config.js
export default {
  condaEnv: process.env.CONDA_ENV_NAME || 'base',
}
```

```bash
# æ¯ä¸ªäººåœ¨å¯åŠ¨å‰è®¾ç½®
set CONDA_ENV_NAME=xm
npm run dev
```

---

## âœ… éªŒè¯ä¸æµ‹è¯•

### 1. æ£€æŸ¥GDALå®‰è£…

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate xm

# æ£€æŸ¥GDALç‰ˆæœ¬
gdalinfo --version

# åº”è¯¥æ˜¾ç¤ºç±»ä¼¼ï¼š
# GDAL 3.8.0, released 2023/11/16
```

### 2. æµ‹è¯•GDALå‘½ä»¤

```bash
# è¿›å…¥æ•°æ®ç›®å½•
cd public\data

# æµ‹è¯•gdalinfoï¼ˆæŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯ï¼‰
gdalinfo 2024_kle_vh_kndvi.tif

# åº”è¯¥æ˜¾ç¤ºæ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼ˆæŠ•å½±ã€å°ºå¯¸ç­‰ï¼‰
```

### 3. æµ‹è¯•åç«¯å¯åŠ¨

```bash
# åœ¨Anaconda Promptä¸­
conda activate xm
cd server
npm run dev

# åº”è¯¥çœ‹åˆ°ï¼š
# ğŸ” å¼€å§‹åŒæ­¥å…ƒæ•°æ®...
# âœ… GDALå·²å®‰è£…: GDAL 3.x.x
# æœåŠ¡å™¨å·²å¯åŠ¨: http://localhost:8080
```

### 4. æµ‹è¯•ä¼˜åŒ–åŠŸèƒ½

1. æ‰“å¼€å‰ç«¯ï¼š`http://localhost:3000`
2. è¿›å…¥"å½±åƒæ•°æ®ç®¡ç†"
3. é€‰æ‹©ä¸€ä¸ªæœªä¼˜åŒ–çš„TIFæ–‡ä»¶
4. ç‚¹å‡»"ä¼˜åŒ–TIF"
5. è§‚å¯Ÿè¿›åº¦æ¡å’Œåç«¯æ—¥å¿—

**é¢„æœŸç»“æœï¼š**
- è¿›åº¦æ¡ä» 0% â†’ 20% â†’ 70% â†’ 90% â†’ 100%
- åç«¯æ˜¾ç¤ºï¼š
  ```
  ğŸš€ å¼€å§‹ä¼˜åŒ–: xxx.tif
  â³ æ­¥éª¤1/3: æŠ•å½±è½¬æ¢ + COGæ ¼å¼è½¬æ¢...
  âœ… æŠ•å½±è½¬æ¢å®Œæˆ
  â³ æ­¥éª¤2/3: æ·»åŠ é‡‘å­—å¡”...
  âœ… é‡‘å­—å¡”æ·»åŠ å®Œæˆ
  âœ… ä¼˜åŒ–æˆåŠŸ!
  ```

---

## ğŸ“š ç›¸å…³èµ„æº

- [GDALå®˜æ–¹æ–‡æ¡£](https://gdal.org/)
- [Condaå®˜æ–¹æ–‡æ¡£](https://docs.conda.io/)
- [COGæ ¼å¼è¯´æ˜](https://www.cogeo.org/)

---

## ğŸ†˜ ä»æœ‰é—®é¢˜ï¼Ÿ

### é€æ­¥æ’æŸ¥æ¸…å•

- [ ] æ˜¯å¦åœ¨ **Anaconda Prompt** ä¸­å¯åŠ¨ï¼Ÿ
- [ ] æ˜¯å¦æ¿€æ´»äº†æ­£ç¡®çš„condaç¯å¢ƒï¼Ÿ
- [ ] `conda env list` ä¸­æ˜¯å¦æœ‰ä½ é…ç½®çš„ç¯å¢ƒï¼Ÿ
- [ ] `gdalinfo --version` æ˜¯å¦èƒ½æ­£å¸¸æ˜¾ç¤ºç‰ˆæœ¬ï¼Ÿ
- [ ] `server/config.js` ä¸­çš„ `condaEnv` æ˜¯å¦æ­£ç¡®ï¼Ÿ
- [ ] åç«¯å¯åŠ¨æ—¶æ˜¯å¦æ˜¾ç¤º"âœ… GDALå·²å®‰è£…"ï¼Ÿ
- [ ] ç«¯å£8080æ˜¯å¦è¢«å ç”¨ï¼Ÿ

### è·å–å¸®åŠ©

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•è§£å†³ï¼Œè¯·æä¾›ï¼š
1. `conda env list` çš„è¾“å‡º
2. `gdalinfo --version` çš„è¾“å‡ºï¼ˆåœ¨condaç¯å¢ƒä¸­ï¼‰
3. åç«¯å¯åŠ¨æ—¶çš„å®Œæ•´æ—¥å¿—
4. æ“ä½œç³»ç»Ÿå’ŒAnacondaç‰ˆæœ¬

---

> **æœ€åæ›´æ–°ï¼š** 2025-10-17  
> **ç‰ˆæœ¬ï¼š** v3.0 - æ•´åˆç‰ˆ

